<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(비즈테크) For BizTech Edition - 클래식 ERP</title>
    <style>
        :root {
            --erp-bg: #f1f5f9;
            --erp-header-bg: #ffffff;
            --erp-toolbar-bg: #f8fafc;
            --win-blue: #1e293b;
            --accent-primary: #2563eb;
            --accent-success: #10b981;
            --accent-error: #ef4444;
            --accent-warning: #f59e0b;
            --btn-border: #cbd5e1;
            --input-border: #94a3b8;
            --table-header: #e2e8f0;
            --win-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Malgun Gothic', 'Dotum', sans-serif;
        }

        body {
            background: #334155;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Layout Helpers */
        .flex-row {
            display: flex;
            gap: 10px;
        }

        .flex-1 {
            flex: 1;
        }

        .p-2 {
            padding: 8px;
        }

        /* System & Menu Bar */
        .system-bar {
            background: #fff;
            padding: 4px 12px;
            font-size: 11px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
        }

        .menu-bar {
            background: #fff;
            display: flex;
            border-bottom: 1px solid #aaa;
        }

        .menu-item {
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            position: relative;
        }

        .menu-item:hover {
            background: #e2e8f0;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: #fff;
            border: 1px solid #aaa;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            min-width: 180px;
        }

        .menu-item:hover>.dropdown-menu {
            display: block;
        }

        .dropdown-item {
            padding: 6px 15px;
            font-size: 12px;
            border-bottom: 1px solid #eee;
        }

        .dropdown-item:hover {
            background: #2563eb;
            color: #fff;
        }

        .workspace {
            flex: 1;
            position: relative;
            padding: 5px;
            background: #475569;
        }

        /* ERP Window Shell */
        .erp-window {
            background: #e2e8f0;
            border: 1px solid #64748b;
            box-shadow: var(--win-shadow);
            display: flex;
            flex-direction: column;
            position: absolute;
            width: 1200px;
            height: 900px;
            max-width: 98vw;
            max-height: calc(100vh - 80px);
            /* 시스템바/메뉴바 제외 */
            top: 0px;
            left: 0px;
            resize: both;
            overflow: hidden;
            border-radius: 4px;
        }

        .erp-window.maximized {
            width: 100% !important;
            height: calc(100% - 42px) !important;
            top: 0 !important;
            left: 0 !important;
            border-radius: 0;
        }

        .window-title-bar {
            background: #334155;
            color: #fff;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            font-size: 12px;
            cursor: move;
        }

        .window-controls {
            margin-left: auto;
            display: flex;
            gap: 2px;
        }

        .win-btn {
            width: 26px;
            height: 18px;
            border: 1px solid #64748b;
            background: #475569;
            color: #fff;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .win-btn:hover {
            background: #64748b;
        }

        .win-btn.close-btn:hover {
            background: #ef4444;
        }

        /* Toolbar */
        .erp-toolbar {
            background: #cbd5e1;
            padding: 4px;
            display: flex;
            gap: 4px;
            border-bottom: 1px solid #94a3b8;
        }

        .tool-btn {
            background: #f8fafc;
            border: 1px solid #94a3b8;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            border-radius: 2px;
        }

        .tool-btn:hover {
            background: #e2e8f0;
        }

        /* Layout: Top Form Blocks */
        .top-form-grid {
            display: grid;
            grid-template-columns: 280px 1fr 340px;
            gap: 6px;
            padding: 6px;
            background: #cbd5e1;
        }

        .group-box {
            border: 1px solid #94a3b8;
            padding: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            position: relative;
        }

        .group-box-title {
            position: absolute;
            top: -8px;
            left: 10px;
            background: #e2e8f0;
            padding: 0 4px;
            font-size: 11px;
            font-weight: bold;
            color: #1e293b;
        }

        /* Form Controls (Restore legacy styles for registration windows) */
        .form-container {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
            background: #fff;
            margin: 5px;
            border: 1px solid #cbd5e1;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .input-row label {
            font-size: 11px;
            min-width: 80px;
            text-align: right;
            color: #1e293b;
            font-weight: bold;
        }

        .input-row input,
        .input-row select,
        .input-row textarea {
            flex: 1;
            padding: 3px 6px;
            border: 1px solid #94a3b8;
            font-size: 12px;
        }

        .input-row input:focus {
            background: #fff8e1;
            border-color: #2563eb;
            outline: none;
        }

        /* Form Controls (New styled rows for sales-reg) */
        .field-row {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 4px;
        }

        .field-row label {
            font-size: 11px;
            width: 65px;
            text-align: right;
            font-weight: bold;
        }

        .field-row input {
            padding: 2px 4px;
            border: 1px solid #94a3b8;
            font-size: 12px;
            ime-mode: active;
            /* 한글 우선 모드 (Internet Explorer/Legacy) */
            -webkit-ime-mode: active;
            /* Edge/Chrome hint */
        }

        /* Modern IME hint - Suggesting Korean */
        input:not([type="number"]) {
            ime-mode: active;
            -webkit-ime-mode: active;
        }

        .input-pname {
            ime-mode: active !important;
            -webkit-ime-mode: active !important;
        }

        .input-pname:read-only {
            background-color: #f8fafc;
            color: #64748b;
            cursor: default;
        }

        /* Hide Number Spin Buttons for PC input */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Main Content Split */
        .window-body {
            flex: 1;
            display: flex;
            overflow: hidden;
            padding: 4px;
            gap: 4px;
        }

        .main-grid-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .side-info-area {
            width: 450px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            border-left: 1px solid #94a3b8;
            padding-left: 4px;
        }

        .data-grid-container {
            flex: 1;
            overflow: auto;
            background: #fff;
            border: 1px solid #94a3b8;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .data-table th {
            background: #e2e8f0;
            border: 1px solid #94a3b8;
            padding: 4px;
            font-size: 11px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            border: 1px solid #cbd5e1;
            padding: 2px 4px;
            font-size: 12px;
            height: 24px;
        }

        .data-table input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 2px;
        }

        .data-table input:focus {
            background: #fff8e1;
            outline: none;
        }

        .side-table-container {
            border: 1px solid #94a3b8;
            background: #fff;
            flex: 1;
            overflow: auto;
        }

        .side-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }

        .side-table th {
            background: #f1f5f9;
            padding: 4px;
            border: 1px solid #cbd5e1;
        }

        .side-table td {
            border: 1px solid #f1f5f9;
            padding: 2px 4px;
        }

        /* Footer / Summary */
        .window-footer {
            background: #cbd5e1;
            border-top: 1px solid #94a3b8;
            padding: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bottom-summary {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }

        .summary-label {
            font-weight: bold;
        }

        .summary-amount {
            color: #b91c1c;
            font-weight: bold;
            font-size: 14px;
        }

        /* Taskbar */
        .taskbar {
            height: 40px;
            background: #1e293b;
            border-top: 1px solid #334155;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 4px;
        }

        .task-item {
            background: #334155;
            color: #fff;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            border: 1px solid #475569;
            min-width: 140px;
            border-radius: 2px;
        }
    </style>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK (v9+ compat mode for easier integration) -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
</head>

<body>
    <!-- System Info Bar -->
    <header class="system-bar">
        <div>
            <strong>(비즈테크) For BizTech Edition Ver 1.12.51 (데이터 제어)</strong> - 사용자: 관리자
        </div>
        <div id="system-date-display">2026-02-05 (수요일) | 온라인 지원 연동 중</div>
    </header>

    <!-- Main Menu Bar -->
    <nav class="menu-bar">
        <div class="menu-item">
            파일(F)
            <div class="dropdown-menu">
                <div class="dropdown-item">로그인 / 로그아웃</div>
                <div class="dropdown-item">비밀번호 변경</div>
                <div class="dropdown-item" onclick="location.reload()">새로고침(F5)</div>
                <div class="dropdown-item">종료</div>
            </div>
        </div>
        <div class="menu-item">
            매입 & 매출관리(G)
            <div class="dropdown-menu">
                <div class="dropdown-item" onclick="showWindow('sales-reg'); switchTradeType('sales');">
                    매입&매출 등록 <span style="float:right; color:#888; font-size:10px; margin-left:20px;">Ctrl+F1</span>
                </div>
                <div class="dropdown-item">
                    지출전표 작성 <span style="float:right; color:#888; font-size:10px; margin-left:20px;">Ctrl+F2</span>
                </div>
                <div class="dropdown-item">
                    현금시재 입력 <span style="float:right; color:#888; font-size:10px; margin-left:20px;">Ctrl+F3</span>
                </div>
                <div class="dropdown-item">
                    세금계산서 작성 <span style="float:right; color:#888; font-size:10px; margin-left:20px;">Ctrl+F4</span>
                </div>
            </div>
        </div>
        <div class="menu-item">
            조회메뉴
            <div class="dropdown-menu">
                <div class="dropdown-item" onclick="showWindow('complex-inquiry')">거래처 기간별 매입/매출 조회</div>
                <div class="dropdown-item">일반 매입/매출 현황</div>
                <div class="dropdown-item">거래처 조회</div>
                <div class="dropdown-item">기간별 재고현황</div>
                <div class="dropdown-item">제품별 누적 재고현황</div>
                <div class="dropdown-item">분류별 매입/매출 현황</div>
                <div class="dropdown-item">담당자별 매입/매출 현황</div>
                <div class="dropdown-item">거래처 제품별 매입/매출 현황</div>
                <div class="dropdown-item">거래처 일자별 매입/매출 현황</div>
            </div>
        </div>
        <div class="menu-item">
            조회메뉴 2
            <div class="dropdown-menu">
                <div class="dropdown-item">매입처 미지급 현황</div>
                <div class="dropdown-item">매출처 미수금 현황</div>
                <div class="dropdown-item">거래처 입출금 현황</div>
                <div class="dropdown-item">월간 영업 캘린더</div>
                <div class="dropdown-item">거래처 일별 집계</div>
                <div class="dropdown-item">일일 거래마감 현황</div>
                <div class="dropdown-item">세금계산서 작성 내역</div>
            </div>
        </div>
        <div class="menu-item">
            기초자료 관리(C)
            <div class="dropdown-menu">
                <div class="dropdown-item" onclick="showWindow('company-reg')">사업체등록</div>
                <div class="dropdown-item" onclick="showWindow('customer-reg')">거래처등록 / 조회</div>
                <div class="dropdown-item" onclick="showWindow('product-reg')">제품등록 / 조회</div>
                <div class="dropdown-item">기본정보등록</div>
                <div class="dropdown-item" onclick="showWindow('settings-window')">환경설정</div>
            </div>
        </div>
        <div class="menu-item">온라인 원격제어</div>
        <div class="menu-item">백업</div>
    </nav>

    <main class="workspace">
        <!-- 1. 거래처 등록 윈도우 (사진 KakaoTalk_20260204_114912544.jpg 기반) -->
        <div id="customer-reg" class="erp-window" style="display: none;">
            <div class="window-title-bar">
                <i data-lucide="users" style="width: 14px; margin-right: 8px;"></i> 거래처 등록
                <div class="window-controls">
                    <div class="win-btn" onclick="minimizeWindow('customer-reg')">_</div>
                    <div class="win-btn" onclick="maximizeWindow('customer-reg')">□</div>
                    <div class="win-btn close-btn" onclick="hideWindow('customer-reg')"
                        style="background: var(--accent-error); color: white;">×</div>
                </div>
            </div>

            <div class="erp-toolbar">
                <button class="tool-btn" onclick="newCustomer()"><i data-lucide="user-plus"></i> 신규(F3)</button>
                <button class="tool-btn" onclick="deleteCustomer()"><i data-lucide="trash-2"></i> 삭제</button>
                <button class="tool-btn" onclick="saveCustomer()" style="background: #e3f2fd;"><i
                        data-lucide="save"></i> 저장(F8)</button>
                <button class="tool-btn" onclick="newCustomer()"><i data-lucide="refresh-cw"></i> 초기화</button>
                <div style="margin-left: auto; display: flex; align-items: center; gap: 5px;">
                    <i data-lucide="search" style="width:14px;"></i>
                    <input type="text" id="cust-search" placeholder="거래처 검색..." oninput="renderCustomerTable()"
                        style="padding: 2px 5px; font-size: 12px; border: 1px solid #ccc;">
                </div>
                <button class="tool-btn" onclick="hideWindow('customer-reg')"><i data-lucide="x-circle"></i>
                    종료(F10)</button>
            </div>

            <section class="form-container" style="grid-template-columns: repeat(3, 1fr);">
                <!-- 행 1 -->
                <div class="input-row"><label>거래처코드</label><input type="text" readonly></div>
                <div class="input-row"><label>사업자번호</label><input type="text"></div>
                <div class="input-row"><label>대표자명</label><input type="text"></div>

                <!-- 행 2 -->
                <div class="input-row"><label>구분</label><select>
                        <option>매출처</option>
                        <option>매입처</option>
                    </select></div>
                <div class="input-row"><label>업태</label><input type="text"></div>
                <div class="input-row"><label>전화번호</label><input type="text"></div>

                <!-- 행 3 -->
                <div class="input-row"><label>거래처명</label><input type="text"></div>
                <div class="input-row"><label>종목</label><input type="text"></div>
                <div class="input-row"><label>휴대폰</label><input type="text"></div>

                <!-- 행 4 -->
                <div class="input-row"><label>담당자</label><input type="text"></div>
                <div class="input-row"><label>이메일</label><input type="text"></div>
                <div class="input-row"><label>비고</label><input type="text"></div>

                <!-- 주소 (전체 너비) -->
                <div class="input-row" style="grid-column: span 3;"><label>사업장주소</label><input type="text"></div>
            </section>

            <div class="data-grid-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 35px;">No</th>
                            <th style="width: 60px;">코드</th>
                            <th style="width: 80px;">구분</th>
                            <th>거래처명</th>
                            <th>사업자번호</th>
                            <th>대표자</th>
                            <th>전화번호</th>
                            <th>휴대폰</th>
                            <th>담당자</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td align="center">1</td>
                            <td>(주) 비즈테크</td>
                            <td>123-45-67890</td>
                            <td>안관리</td>
                            <td>02-1234-5678</td>
                            <td>010-1111-2222</td>
                            <td>김철수</td>
                            <td>주거래처</td>
                        </tr>
                        <tr>
                            <td align="center">2</td>
                            <td>미래보안 기술</td>
                            <td>505-11-22334</td>
                            <td>이대표</td>
                            <td>031-987-6543</td>
                            <td>010-9999-8888</td>
                            <td>박영희</td>
                            <td>미결제 주의</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 5. 거래처 기간별 매입/매출 조회 (사진 113713 기반) -->
        <div id="complex-inquiry" class="erp-window" style="display: none; top: 0px; left: 0px;">
            <div class="window-title-bar">
                <i data-lucide="search" style="width: 14px; margin-right: 8px;"></i> 거래처 기간별 매입/매출 조회
                <div class="window-controls">
                    <div class="win-btn" onclick="minimizeWindow('complex-inquiry')">_</div>
                    <div class="win-btn" onclick="maximizeWindow('complex-inquiry')">□</div>
                    <div class="win-btn close-btn" onclick="hideWindow('complex-inquiry')"
                        style="background: var(--accent-error); color: white;">×</div>
                </div>
            </div>
            <div class="erp-toolbar">
                <button class="tool-btn"><i data-lucide="search"></i> 조회(F2)</button>
                <button class="tool-btn"><i data-lucide="printer"></i> 출력(F11)</button>
                <button class="tool-btn"><i data-lucide="file-spreadsheet"></i> 엑셀변환(F12)</button>
                <button class="tool-btn" onclick="hideWindow('complex-inquiry')"><i data-lucide="x-circle"></i>
                    종료(F10)</button>
            </div>
            <!-- 검색 영역: 사진 기반 상세 검색 필드 레이아웃 -->
            <div style="padding: 6px; background: #cbd5e1; margin-bottom: 20px;">
                <div class="group-box" style="background: #f0eee1;">
                    <div class="group-box-title">검색 조건 상세 설정</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 5px 0;">
                        <!-- 행 1 -->
                        <div class="field-row">
                            <label style="width: 55px;">거래일자</label>
                            <input type="date" value="2026-02-01" style="width: 90px; font-size: 11px;">
                            <span style="padding: 0 1px;">~</span>
                            <input type="date" value="2026-02-04" style="width: 90px; font-size: 11px;">
                        </div>
                        <div class="field-row">
                            <label style="width: 65px;">거래구분</label>
                            <select style="flex:1;">
                                <option>매출</option>
                                <option>매입</option>
                            </select>
                        </div>
                        <div class="field-row">
                            <label style="width: 65px;">거래처조건</label>
                            <select style="flex:1;">
                                <option>매출거래처</option>
                            </select>
                        </div>
                        <div class="field-row">
                            <label style="width: 50px;">거래처</label>
                            <input type="text" style="flex:1;">
                            <button style="padding: 0 4px; font-size: 10px;">...</button>
                        </div>

                        <!-- 행 2 -->
                        <div class="field-row">
                            <label style="width: 55px;">조회구분</label>
                            <select style="flex:1;">
                                <option>1 단계</option>
                            </select>
                        </div>
                        <div class="field-row">
                            <label style="width: 65px;">담 당</label>
                            <input type="text" style="flex:1;">
                        </div>
                        <div class="field-row">
                            <label style="width: 65px;">제 품 명</label>
                            <input type="text" style="flex:1;">
                        </div>
                        <div class="field-row">
                            <label style="width: 55px;">정렬조건</label>
                            <select style="flex:1;">
                                <option>거래처 코드로 정렬</option>
                            </select>
                        </div>

                        <!-- 행 3 -->
                        <div class="field-row">
                            <label style="width: 55px;">할인금액</label>
                            <select style="flex:1;">
                                <option>미포함</option>
                                <option>포함</option>
                            </select>
                        </div>
                        <div class="field-row">
                            <label style="width: 65px;">담 당 자</label>
                            <select style="flex:1;">
                                <option></option>
                            </select>
                        </div>
                        <div class="field-row">
                            <label style="width: 65px;">리포트</label>
                            <select style="flex:1;">
                                <option>미출력</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 검색 영역 하단 공백 제거 및 표 영역 시작 -->
            <div class="data-grid-container" style="margin-top: 0; flex: 1;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 35px;">No</th>
                            <th style="width: 85px;">거래일자</th>
                            <th style="width: 150px;">거래처명</th>
                            <th style="width: 100px;">전일잔액</th>
                            <th style="width: 70px;">매출수량</th>
                            <th style="width: 90px;">단가</th>
                            <th style="width: 110px;">총금액</th>
                            <th style="width: 100px;">반품(할인)</th>
                            <th style="width: 110px;">총금액</th>
                            <th style="width: 110px;">입금금액</th>
                            <th style="width: 110px;">잔액</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td align="center">1</td>
                            <td align="center">2026-02-04</td>
                            <td>(주) 비즈테크</td>
                            <td align="right">1,250,000</td>
                            <td align="right">10</td>
                            <td align="right">85,000</td>
                            <td align="right">935,000</td>
                            <td align="right">0</td>
                            <td align="right">935,000</td>
                            <td align="right">0</td>
                            <td align="right">2,185,000</td>
                        </tr>
                        <!-- 빈 행 추가 (표 영역 시각적 확보) -->
                        <script>
                            for (let i = 0; i < 30; i++) {
                                document.write('<tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>');
                            }
                        </script>
                    </tbody>
                </table>
            </div>

        </div>

        <!-- 6. 환경설정 윈도우 (사진 113841 기반) -->
        <div id="settings-window" class="erp-window"
            style="display: none; height: 600px; width: 800px; left: 0px; top: 0px;">
            <div class="window-title-bar">
                <i data-lucide="settings" style="width: 14px; margin-right: 8px;"></i> 환경설정
                <div class="window-controls">
                    <div class="win-btn" onclick="minimizeWindow('settings-window')">_</div>
                    <div class="win-btn" onclick="maximizeWindow('settings-window')">□</div>
                    <div class="win-btn close-btn" onclick="hideWindow('settings-window')"
                        style="background: var(--accent-error); color: white;">×</div>
                </div>
            </div>
            <div style="background: #ccc; padding: 10px; color: #e81123; font-weight: bold; text-align: center;">로그인
                계정
                및 프로그램 환경설정</div>
            <div class="erp-toolbar" style="justify-content: flex-end;">
                <button class="tool-btn"><i data-lucide="save"></i> 저장후닫기</button>
                <button class="tool-btn" onclick="hideWindow('settings-window')">닫기</button>
            </div>
            <div style="display: flex; flex: 1; border-top: 1px solid #888;">
                <div style="width: 150px; background: #eee; border-right: 1px solid #ccc; padding: 10px;">
                    <div
                        style="padding: 8px; background: #fff; border: 1px solid #aaa; margin-bottom: 4px; font-size: 12px; font-weight: bold;">
                        로그인 계정</div>
                    <div style="padding: 8px; font-size: 12px;">환경설정</div>
                    <div style="padding: 8px; font-size: 12px;">업체기본정보</div>
                    <div style="padding: 8px; font-size: 12px;">통장관리</div>
                    <div style="padding: 8px; font-size: 12px;">SMS 설정</div>
                </div>
                <div style="flex: 1; background: #fff; padding: 15px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>로그인명</th>
                                <th>비밀번호</th>
                                <th>수정</th>
                                <th>삭제</th>
                                <th>매입매출</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>관리자</td>
                                <td>****</td>
                                <td align="center">V</td>
                                <td align="center">V</td>
                                <td align="center">V</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- 2. 매입/매출 통합 등록 윈도우 -->
        <div id="sales-reg" class="erp-window" style="display: none;">
            <div class="window-title-bar">
                <i data-lucide="shopping-cart" style="width: 14px; margin-right: 8px;"></i> <span id="reg-title">매입&매출
                    등록</span>
                <div class="window-controls">
                    <div class="win-btn" onclick="minimizeWindow('sales-reg')">_</div>
                    <div class="win-btn" onclick="maximizeWindow('sales-reg')">□</div>
                    <div class="win-btn close-btn" onclick="hideWindow('sales-reg')">×</div>
                </div>
            </div>

            <div class="erp-toolbar">
                <button class="tool-btn"><i data-lucide="bar-chart-2"></i> 통계(F2)</button>
                <button class="tool-btn"><i data-lucide="file-text"></i> 거래명세서(F9)</button>
                <button class="tool-btn"><i data-lucide="receipt"></i> 거래영수증(F7)</button>
                <button class="tool-btn" onclick="saveTransaction()" style="background:#dcfce7; font-weight:bold;"><i
                        data-lucide="save"></i> 저장(F8)</button>
                <button class="tool-btn" onclick="hideWindow('sales-reg')"><i data-lucide="x-circle"></i>
                    종료(F10)</button>
            </div>

            <!-- Top Grid Layout -->
            <!-- Top Grid Layout (Re-organized for requested layout) -->
            <div style="display: grid; grid-template-columns: 1fr 450px; gap: 4px; padding: 6px; background: #cbd5e1;">
                <!-- Left Side: Two Long Horizontal Boxes -->
                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <!-- Row 1: Customer Info + Writing Info -->
                    <div style="display: flex; gap: 4px;">
                        <!-- Group 1: 거래처 정보 -->
                        <div class="group-box" style="flex: 1;">
                            <div class="group-box-title">거래처 정보</div>
                            <div class="field-row">
                                <label>처리구분</label>
                                <select id="trade-type-select" onchange="switchTradeType(this.value)" style="flex:1;">
                                    <option value="sales">매 출</option>
                                    <option value="purchase">매 입</option>
                                </select>
                                <select style="width:60px;">
                                    <option>일반</option>
                                </select>
                            </div>
                            <div class="field-row">
                                <label>거 래 처</label>
                                <input type="text" id="sales-customer-input" list="customer-list-dl" style="flex:1;">
                                <button style="font-size:10px; padding:2px 4px;">변경</button>
                            </div>
                            <div class="field-row">
                                <label>담 당 자</label><input type="text" value="관리자" style="flex:1;">
                            </div>
                        </div>

                        <!-- Group 2: 작성 정보 -->
                        <div class="group-box" style="flex: 1.5;">
                            <div class="group-box-title">작성 정보</div>
                            <div class="field-row">
                                <label>작성거래처</label>
                                <input type="text" id="sales-customer-input" list="customer-list-dl" autocomplete="off"
                                    style="flex:1; background:#fff; font-weight:bold; border:1px solid #475569;"
                                    oninput="updateCustomerHistory(this.value);" onclick="handleCustomerClick();">
                                <label style="width:60px;">거래일자</label>
                                <input type="date" id="trade-date-input" style="width:110px;"
                                    onchange="updateSystemDate();">
                                <button style="font-size:10px; padding:2px 4px;" onclick="setTodayDate();">오늘</button>
                            </div>
                            <div class="field-row">
                                <label>작성순번</label>
                                <div style="display:flex; align-items:center; gap:2px; flex:1;">
                                    <input type="text" id="reg-seq" value="1" style="width:40px; text-align:center;">
                                    <button style="padding:0 4px;" onclick="changeSeq(-1)">◀</button><button
                                        style="padding:0 4px;" onclick="changeSeq(1)">▶</button>
                                </div>
                                <label style="width:60px;">작성시간</label>
                                <input type="text" id="reg-time" value="22:45:01"
                                    style="width:70px; background:#f1f5f9;" readonly>
                                <label style="width:60px;">전표번호</label>
                                <input type="text" id="reg-no" style="width:60px; background:#f1f5f9;" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Balance Info Bar (Moved into Top Area) -->
                    <div class="group-box" style="padding: 4px 8px; background: #e2e8f0;">
                        <div class="group-box-title">거래 요약 및 잔액 정보</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1.4fr; gap:6px; font-size:11px;">
                            <div class="field-row" style="margin:0;"><label style="width:55px;">전일잔액</label><input
                                    type="text" id="info-prev-balance"
                                    style="flex:1; background:#fff; text-align:right; padding-right:4px;" readonly>
                            </div>
                            <div class="field-row" style="margin:0;"><label style="width:55px;">최종거래일</label><input
                                    type="text" id="info-last-date" style="flex:1; background:#fff; text-align:center;"
                                    readonly></div>
                            <div class="field-row" style="margin:0;"><label style="width:55px;">입금금액</label><input
                                    type="text" id="info-paying"
                                    style="flex:1; background:#fff; text-align:right; padding-right:4px;" readonly>
                            </div>
                            <div class="field-row" style="margin:0;"><label style="width:55px;">금일합계</label><input
                                    type="text" id="info-today-sum"
                                    style="flex:1; background:#fff; text-align:right; padding-right:5px; font-weight:bold;"
                                    readonly>
                            </div>
                        </div>
                        <div
                            style="display:grid; grid-template-columns: 1fr 1fr 1fr 1.4fr; gap:6px; font-size:11px; margin-top:4px;">
                            <div class="field-row" style="margin:0;"><label style="width:55px;">판매담당</label><input
                                    type="text" id="info-manager" value="관리자"
                                    style="flex:1; background:#fff; padding-left:4px;"></div>
                            <div class="field-row" style="margin:0;"><label style="width:60px;">총반품금액</label><input
                                    type="text" id="info-return-sum"
                                    style="flex:1; background:#fff; text-align:right; padding-right:4px;" readonly>
                            </div>
                            <div class="field-row" style="margin:0;"><label style="width:55px;">할인금액</label><input
                                    type="text" id="info-discount-sum"
                                    style="flex:1; background:#fff; text-align:right; padding-right:4px;" readonly>
                            </div>
                            <div class="field-row" style="margin:0;"><label
                                    style="width:55px; color:#c2410c; font-weight:bold;">총 잔 액</label><input type="text"
                                    id="info-total-balance"
                                    style="flex:1; background:#fff8e1; font-weight:bold; color:#c2410c; text-align:right; padding-right:5px;"
                                    readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Side: Tax/Payment Box (Aligns with both left rows) -->
                <div class="group-box" style="height: 100%; margin-top: 2px;">
                    <div style="display:flex; gap:6px; height:100%;">
                        <div
                            style="flex:1; display:flex; flex-direction:column; justify-content: space-between; padding: 5px; gap: 8px; border-right:1px solid #cbd5e1; background: #f8fafc; position: relative;">
                            <div class="group-box-title">결제사항 등록</div>
                            <div class="field-row" style="margin:0;">
                                <label style="width:40px; font-size:12px;">현금</label>
                                <input type="text" id="pay-cash"
                                    style="flex:1; text-align:right; font-size:14px; height: 28px; font-weight: bold; border: 1px solid #94a3b8; padding: 0 8px;"
                                    oninput="this.value=this.value.replace(/[^0-9]/g,''); updateTotals();">
                            </div>
                            <div class="field-row" style="margin:0;">
                                <label style="width:40px; font-size:12px;">할인</label>
                                <input type="text" id="pay-discount"
                                    style="flex:1; text-align:right; font-size:14px; height: 28px; font-weight: bold; border: 1px solid #94a3b8; padding: 0 8px;"
                                    oninput="this.value=this.value.replace(/[^0-9]/g,''); updateTotals();">
                            </div>
                            <div class="field-row" style="margin:0;">
                                <label style="width:40px; font-size:12px;">통장</label>
                                <input type="text" id="pay-bank"
                                    style="flex:1; text-align:right; font-size:14px; height: 28px; font-weight: bold; border: 1px solid #94a3b8; padding: 0 8px;"
                                    oninput="this.value=this.value.replace(/[^0-9]/g,''); updateTotals();">
                            </div>
                            <div class="field-row" style="margin:0;">
                                <label style="width:40px; font-size:12px;">카드</label>
                                <input type="text" id="pay-card"
                                    style="flex:1; text-align:right; font-size:14px; height: 28px; font-weight: bold; border: 1px solid #94a3b8; padding: 0 8px;"
                                    oninput="this.value=this.value.replace(/[^0-9]/g,''); updateTotals();">
                            </div>
                        </div>
                        <div
                            style="width:130px; padding: 5px; font-size:12px; display: flex; flex-direction: column; justify-content: space-around; position: relative;">
                            <div class="group-box-title">과세 구분</div>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input
                                    type="radio" name="tax-opt"> 세금계산서</label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input
                                    type="radio" name="tax-opt" checked> 계산서</label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;"><input
                                    type="checkbox"> 부가세별도</label>
                            <div
                                style="border-top:1px solid #cbd5e1; padding-top: 5px; display: flex; gap: 10px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input
                                        type="radio" name="pay-type"> 영수</label>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input
                                        type="radio" name="pay-type" checked> 청구</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="window-body">
                <!-- Main Grid Area -->
                <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                    <!-- Reset Bar -->
                    <div
                        style="display:flex; align-items:center; gap:10px; padding:2px 10px; background:#e2e8f0; border:1px solid #94a3b8; border-bottom:none; font-size:11px; margin-right:4px;">
                        <div style="display:flex; align-items:center; gap:4px;">
                            <input type="radio" name="amt-type" checked> 금액
                            <input type="text" value="0"
                                style="width:100px; text-align:right; font-weight:bold; background:#fff; border:1px solid #94a3b8;">
                        </div>
                    </div>

                    <div class="main-grid-area" style="margin-right:4px;">
                        <div class="data-grid-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th style="width: 35px;">No</th>
                                        <th style="width: 250px;">제품명</th>
                                        <th style="width: 60px;">수량</th>
                                        <th style="width: 100px;">단가</th>
                                        <th style="width: 110px;">공급가액</th>
                                        <th>비고</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-grid-body"></tbody>
                            </table>
                        </div>
                        <!-- Memo / Footer Small Box -->
                        <div style="height:60px; display:flex; gap:4px; padding-top:4px;">
                            <div class="group-box flex-1">
                                <div class="group-box-title">메모</div>
                                <textarea
                                    style="width:100%; height:100%; border:none; background:transparent; font-size:11px; outline:none;"
                                    placeholder="내용을 입력하세요"></textarea>
                            </div>
                            <div class="group-box" style="width:250px;">
                                <div class="group-box-title">집계 내역</div>
                                <div style="font-size:11px; line-height:1.2;">
                                    공급가액: <span id="sum-supply" style="float:right;">0</span><br>
                                    부가세액: <span id="sum-tax" style="float:right;">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar (History/Stock) -->
                <div class="side-info-area">
                    <div class="side-table-container">
                        <div style="background:#475569; color:#fff; font-size:10px; padding:2px 6px;">거래 상세 내역</div>
                        <table class="side-table">
                            <thead>
                                <tr>
                                    <th>일자</th>
                                    <th>품명</th>
                                    <th>수량</th>
                                </tr>
                            </thead>
                            <tbody id="side-history-body">
                                <tr>
                                    <td colspan="3" align="center" style="color:#999; padding:20px 0;">거래처 선택 시 표시
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="side-table-container" style="height:150px; flex:none;">
                        <div style="background:#475569; color:#fff; font-size:10px; padding:2px 6px;">제품 재고</div>
                        <table class="side-table">
                            <thead>
                                <tr>
                                    <th>제품</th>
                                    <th>재고</th>
                                </tr>
                            </thead>
                            <tbody id="side-stock-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <footer class="window-footer">
                <div class="bottom-summary">
                    <div><span class="summary-label">전일잔액:</span> 0</div>
                    <div><span class="summary-label">판매합계:</span> <span id="sum-total-footer"
                            class="summary-amount">0</span></div>
                    <div><span class="summary-label">입금금액:</span> 0</div>
                    <div><span class="summary-label">현재잔액:</span> 0</div>
                </div>
            </footer>
        </div>

        <!-- 4. 사업체 등록 윈도우 (신규 추가) -->
        <div id="company-reg" class="erp-window" style="display: none;">
            <div class="window-title-bar">
                <i data-lucide="building" style="width: 14px; margin-right: 8px;"></i> 사업체 등록
                <div class="window-controls">
                    <div class="win-btn" onclick="minimizeWindow('company-reg')">_</div>
                    <div class="win-btn" onclick="maximizeWindow('company-reg')">□</div>
                    <div class="win-btn close-btn" onclick="hideWindow('company-reg')"
                        style="background: var(--accent-error); color: white;">×</div>
                </div>
            </div>

            <div class="erp-toolbar">
                <button class="tool-btn" style="background: #e3f2fd;"><i data-lucide="save"></i> 저장(F8)</button>
                <button class="tool-btn" onclick="hideWindow('company-reg')"><i data-lucide="x-circle"></i>
                    종료(F10)</button>
            </div>

            <section class="form-container" style="grid-template-columns: repeat(2, 1fr);">
                <div class="input-row"><label>사업자번호</label><input type="text" placeholder="000-00-00000"></div>
                <div class="input-row"><label>법인번호</label><input type="text"></div>

                <div class="input-row"><label>상호명</label><input type="text" value="(주) 비즈테크"></div>
                <div class="input-row"><label>대표자명</label><input type="text"></div>

                <div class="input-row"><label>업태</label><input type="text"></div>
                <div class="input-row"><label>종목</label><input type="text"></div>

                <div class="input-row" style="grid-column: span 2;"><label>사업장주소</label><input type="text"></div>

                <div class="input-row"><label>전화번호</label><input type="text"></div>
                <div class="input-row"><label>팩스번호</label><input type="text"></div>

                <div class="input-row"><label>홈페이지</label><input type="text"></div>
                <div class="input-row"><label>국세청전송용ID</label><input type="text"></div>
            </section>

            <div
                style="padding: 20px; background: #fff; margin: 10px; border: 1px solid #ddd; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <div
                    style="width: 120px; height: 120px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                    <span style="font-size: 12px; color: #999;">인감/도장 이미지</span>
                </div>
                <button class="tool-btn">이미지 등록</button>
            </div>
        </div>
        <!-- 3. 제품 등록 윈도우 (구조 수정 완료) -->
        <div id="product-reg" class="erp-window" style="display: none;">
            <div class="window-title-bar">
                <i data-lucide="package" style="width: 14px; margin-right: 8px;"></i> 제품 등록
                <div class="window-controls">
                    <div class="win-btn" onclick="minimizeWindow('product-reg')">_</div>
                    <div class="win-btn" onclick="maximizeWindow('product-reg')">□</div>
                    <div class="win-btn close-btn" onclick="hideWindow('product-reg')"
                        style="background: var(--accent-error); color: white;">×</div>
                </div>
            </div>

            <!-- TALL TOOLBAR (Screenshot based) -->
            <div class="erp-toolbar"
                style="height: 100px; padding: 10px; border-bottom: 2px solid #ccc; background: #e0e4e9; align-items: stretch;">
                <div style="display: flex; gap: 4px;">
                    <button class="tool-btn" onclick="newProduct()"><i data-lucide="plus-circle"></i>
                        신규(F3)</button>
                    <button class="tool-btn" onclick="deleteProduct()"><i data-lucide="trash-2"></i> 삭제</button>
                    <button class="tool-btn" onclick="saveProduct()"
                        style="background: #e3f2fd; border-color:#90caf9;"><i data-lucide="save"></i>
                        저장(F8)</button>
                </div>

                <div style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <div
                        style="display: flex; align-items: center; gap: 10px; background: #fff; padding: 6px 15px; border: 1px solid #aaa; border-radius: 20px;">
                        <i data-lucide="search" style="width:18px; color: #666;"></i>
                        <input type="text" id="prod-search" placeholder="제품 검색..." oninput="renderProductTable()"
                            style="border: none; outline: none; font-size: 14px; width: 300px;">
                    </div>
                </div>

                <div style="display: flex; align-items: stretch;">
                    <button class="tool-btn" onclick="hideWindow('product-reg')" style="height: auto;">
                        <i data-lucide="x-circle"></i> 종료(F10)
                    </button>
                </div>
            </div>

            <!-- FORM CARD AREA -->
            <div style="background: #e0e4e9; padding: 15px; flex: 0 0 auto;">
                <section class="form-container"
                    style="margin: 0 auto; width: 100%; max-width: 1100px; padding: 25px; border-radius: 0; box-shadow: 2px 2px 8px rgba(0,0,0,0.1); grid-template-columns: repeat(2, 1fr); background: #fff;">
                    <div class="input-row"><label>제품코드</label><input type="text" readonly
                            style="background: #f9f9f9; font-weight: bold;"></div>
                    <div class="input-row"><label>매입단가</label><input type="text"
                            style="font-weight: bold; color: #d32f2f; text-align:right;"
                            oninput="this.value=this.value.replace(/[^0-9]/g,'')"></div>

                    <div class="input-row"><label>제품명</label><input type="text" style="font-weight: bold;"></div>
                    <div class="input-row"><label>매출단가</label><input type="text"
                            style="font-weight: bold; color: #1976d2; text-align:right;"
                            oninput="this.value=this.value.replace(/[^0-9]/g,'')"></div>

                    <div class="input-row"><label>대분류</label><select>
                            <option>대분류 1</option>
                            <option>대분류 2</option>
                        </select></div>
                    <div class="input-row"><label>소분류</label><select>
                            <option>소분류 1</option>
                            <option>소분류 2</option>
                        </select></div>

                    <div class="input-row"><label>현재고</label><input type="text" readonly
                            style="background: #eee; text-align:right;">
                    </div>
                    <div class="input-row"><label>A 단가</label><input type="text" style="text-align:right;"
                            oninput="this.value=this.value.replace(/[^0-9]/g,'')"></div>

                    <div class="input-row" style="grid-column: span 2;"><label>비고</label><input type="text"
                            style="width: 100%;"></div>

                    <!-- 제품 이미지 영역 추가 -->
                    <div
                        style="grid-column: span 2; display: flex; gap: 20px; border-top: 1px solid #eee; margin-top: 10px; padding-top: 15px;">
                        <div
                            style="width: 150px; height: 150px; border: 1px solid #cbd5e1; background: #f8fafc; display: flex; align-items: center; justify-content: center; position: relative;">
                            <i data-lucide="image" style="width: 40px; color: #94a3b8;"></i>
                            <div style="position: absolute; bottom: 5px; right: 5px; font-size: 10px; color: #64748b;">
                                제품 사진</div>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                            <button class="tool-btn" style="height: 40px; min-width: 120px;"><i
                                    data-lucide="upload"></i> 이미지 등록</button>
                            <div style="font-size: 11px; color: #64748b;">
                                * 권장 사이즈: 500x500px<br>
                                * 지원 형식: JPG, PNG, GIF
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- GRID AREA -->
            <div class="data-grid-container" style="margin: 10px 20px 20px 20px;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 35px;">No</th>
                            <th style="width: 120px;">제품코드</th>
                            <th>제품명</th>
                            <th style="width: 120px;">매입가</th>
                            <th style="width: 120px;">매출가</th>
                            <th style="width: 120px;">대분류</th>
                            <th style="width: 120px;">소분류</th>
                            <th style="width: 80px;">현재고</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 데이터 행 -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="taskbar" id="taskbar">
        <!-- Minimized tabs will appear here -->
    </footer>

    <script>
        lucide.createIcons();

        // --- Date Management ---
        function updateSystemDate() {
            const dateInput = document.getElementById('trade-date-input');
            const displayDiv = document.getElementById('system-date-display');
            if (!dateInput || !displayDiv) return;

            const dateValue = dateInput.value;
            if (!dateValue) return;

            const date = new Date(dateValue + 'T00:00:00');
            const days = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
            const dayName = days[date.getDay()];
            displayDiv.textContent = `${dateValue} (${dayName}) | 온라인 지원 연동 중`;
        }

        function setTodayDate() {
            const dateInput = document.getElementById('trade-date-input');
            if (!dateInput) return;

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;

            updateSystemDate();
        }

        // 페이지 로드 시 초기화
        window.addEventListener('DOMContentLoaded', function () {
            setTodayDate();
        });

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyC710X8N4GK5iZHIUUjT8VDZemPjV9jShw",
            authDomain: "b68-kr.firebaseapp.com",
            projectId: "b68-kr",
            storageBucket: "b68-kr.firebasestorage.app",
            messagingSenderId: "826302342661",
            appId: "1:826302342661:web:fd4aad8dac6b50ad979e6c",
            measurementId: "G-1DWY3Y0TFP"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Data Management System (Cloud Sync) ---
        let DB = {
            customers: [],
            products: [],
            transactions: []
        };

        // Real-time Listeners
        function initSync() {
            db.collection("customers").onSnapshot((snapshot) => {
                DB.customers = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                renderCustomerTable();
                updateDatalists(); // 기존 입력창 유지하며 목록만 갱신
            });

            db.collection("products").onSnapshot((snapshot) => {
                DB.products = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                renderProductTable();
                updateDatalists();
            });

            db.collection("transactions").onSnapshot((snapshot) => {
                DB.transactions = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                renderInquiryTable();
            });
        }

        initSync();

        async function saveData(type, data) {
            try {
                // Firebase Firestore에 데이터 저장
                const collectionName = type === 'customer' ? 'customers' :
                    type === 'product' ? 'products' : 'transactions';

                if (data.uid) {
                    await db.collection(collectionName).doc(data.uid).set(data);
                } else {
                    await db.collection(collectionName).add(data);
                }
                console.log(`${type} 데이터가 클라우드 서버에 동기화되었습니다.`);
            } catch (error) {
                console.error("데이터 동기화 실패:", error);
                alert("인터넷 연결을 확인하고 다시 시도해 주세요.");
            }
        }

        // --- Window Management ---
        let zIndex = 100;
        let winOffset = 20;
        let winCount = 0;

        function showWindow(id) {
            const win = document.getElementById(id);
            if (win.style.display !== 'flex') {
                if (!win.dataset.opened) {
                    winCount++;
                    win.style.top = "0px";
                    win.style.left = "0px";
                    makeDraggable(win);
                    win.dataset.opened = "true";
                }
                win.style.top = "0px"; // 열릴 때마다 상단 정렬 강제
                win.style.left = "0px";
                win.style.display = 'flex';
            }
            win.style.zIndex = ++zIndex;

            // If it was minimized, remove from taskbar
            const taskBtn = document.getElementById('task-' + id);
            if (taskBtn) taskBtn.remove();

            if (id === 'customer-reg') renderCustomerTable();
            if (id === 'product-reg') renderProductTable();
            if (id === 'complex-inquiry') renderInquiryTable();
            if (id === 'sales-reg') {
                const customerInput = document.getElementById('sales-customer-input');
                if (!customerInput.value) {
                    renderSalesGrid();
                }
            }
        }

        function handleCustomerClick() {
            const customerInput = document.getElementById('sales-customer-input');
            if (customerInput.value && confirm('화면을 초기화하고 새로 작성하시겠습니까?')) {
                renderSalesGrid();
            } else if (!customerInput.value) {
                renderSalesGrid();
            }
        }

        function minimizeWindow(id) {
            const win = document.getElementById(id);
            win.style.display = 'none';

            const taskbar = document.getElementById('taskbar');
            if (!document.getElementById('task-' + id)) {
                const btn = document.createElement('div');
                btn.id = 'task-' + id;
                btn.className = 'task-item';
                const title = win.querySelector('.window-title-bar').innerText.trim().split('\n')[0];
                btn.innerHTML = `<i data-lucide="window"></i> ${title}`;
                btn.onclick = () => showWindow(id);
                taskbar.appendChild(btn);
                lucide.createIcons();
            }
        }

        function maximizeWindow(id) {
            const win = document.getElementById(id);
            win.classList.toggle('maximized');
        }

        function hideWindow(id) {
            document.getElementById(id).style.display = 'none';
            const taskBtn = document.getElementById('task-' + id);
            if (taskBtn) taskBtn.remove();
        }

        function makeDraggable(el) {
            const header = el.querySelector('.window-title-bar');
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            header.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                el.style.zIndex = ++zIndex;
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                el.style.top = (el.offsetTop - pos2) + "px";
                el.style.left = (el.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // --- Customer Logic ---
        function renderCustomerTable() {
            const tbody = document.querySelector('#customer-reg .data-table tbody');
            const keyword = document.getElementById('cust-search').value.toLowerCase();
            const filtered = DB.customers.filter(c => c.name.toLowerCase().includes(keyword) || c.id.toString().includes(keyword));

            let html = filtered.map((c, i) => `
                <tr onclick="loadCustomer('${c.id}')" style="cursor:pointer;">
                    <td align="right" style="background:#f1f5f9; width:35px; color:#64748b;">${i + 1}</td>
                    <td align="center">${c.id}</td>
                    <td align="center">${c.type || '매출처'}</td>
                    <td style="font-weight:bold; color:#0f172a;">${c.name}</td>
                    <td>${c.bizNo}</td>
                    <td>${c.boss || ''}</td>
                    <td>${c.tel}</td>
                    <td>${c.mobile || ''}</td>
                    <td>${c.manager || ''}</td>
                </tr>
            `).join('');

            // 빈 행 추가 (스크린샷처럼 칸을 채움)
            const minRows = 25;
            for (let i = filtered.length; i < minRows; i++) {
                html += `<tr>
                    <td align="right" style="background:#f1f5f9; color:#94a3b8;">${i + 1}</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>`;
            }
            tbody.innerHTML = html;
        }

        function loadCustomer(id) {
            const c = DB.customers.find(item => item.id == id);
            if (!c) return;
            const form = document.querySelector('#customer-reg .form-container');
            const fields = form.querySelectorAll('input, select');

            fields[0].value = c.id;
            fields[1].value = c.bizNo || '';
            fields[2].value = c.boss || '';
            fields[3].value = c.type || '매출처';
            fields[4].value = c.bizType || '';
            fields[5].value = c.tel || '';
            fields[6].value = c.name || '';
            fields[7].value = c.bizItem || '';
            fields[8].value = c.mobile || '';
            fields[9].value = c.manager || '';
            fields[10].value = c.email || '';
            fields[11].value = c.memo || '';
            fields[12].value = c.address || '';
        }

        async function deleteCustomer() {
            const form = document.querySelector('#customer-reg .form-container');
            const fields = form.querySelectorAll('input, select');
            const id = fields[0].value;
            const c = DB.customers.find(item => item.id == id);

            if (!c) return;
            if (!confirm('정말 삭제하시겠습니까?')) return;

            try {
                await db.collection("customers").doc(c.uid).delete();
                newCustomer();
                alert('삭제되었습니다.');
            } catch (error) {
                alert('삭제 실패: ' + error.message);
            }
        }

        function newCustomer() {
            const form = document.querySelector('#customer-reg .form-container');
            const fields = form.querySelectorAll('input, select');
            const ids = DB.customers.map(c => parseInt(c.id) || 0);
            const nextId = Math.max(...ids, 1000) + 1;
            fields[0].value = nextId;
            for (let i = 1; i < fields.length; i++) fields[i].value = '';
            fields[3].selectedIndex = 0;
        }

        async function saveCustomer() {
            const form = document.querySelector('#customer-reg .form-container');
            const f = form.querySelectorAll('input, select');
            const id = f[0].value;

            // 기존 UID 찾기 (업데이트용)
            const existing = DB.customers.find(c => c.id == id);

            const customerData = {
                id: id,
                bizNo: f[1].value,
                boss: f[2].value,
                type: f[3].value,
                bizType: f[4].value,
                tel: f[5].value,
                name: f[6].value,
                bizItem: f[7].value,
                mobile: f[8].value,
                manager: f[9].value,
                email: f[10].value,
                memo: f[11].value,
                address: f[12].value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (existing && existing.uid) {
                customerData.uid = existing.uid;
            }

            await saveData('customer', customerData);
            alert('저장되었습니다.');
            newCustomer(); // 즉시 다음 번호로 세팅
        }

        // --- Product Logic ---
        function renderProductTable() {
            const tbody = document.querySelector('#product-reg .data-table tbody');
            const keyword = document.getElementById('prod-search').value.toLowerCase();
            const filtered = DB.products.filter(p => p.name.toLowerCase().includes(keyword) || p.id.toString().includes(keyword));

            let html = filtered.map((p, i) => `
                <tr onclick="loadProduct('${p.id}')" style="cursor:pointer;">
                    <td align="right" style="background:#f1f5f9; width:35px; color:#64748b;">${i + 1}</td>
                    <td>${p.id}</td>
                    <td style="font-weight:bold; color:#0f172a;">${p.name}</td>
                    <td align="right" style="color:#ef4444;">${(p.buyPrice || 0).toLocaleString()}</td>
                    <td align="right" style="color:#3b82f6;">${(p.sellPrice || 0).toLocaleString()}</td>
                    <td>${p.cate1 || '-'}</td>
                    <td>${p.subCate1 || '-'}</td>
                    <td align="center">${p.stock || 0}</td>
                </tr>
            `).join('');

            const minRows = 25;
            for (let i = filtered.length; i < minRows; i++) {
                html += `<tr>
                    <td align="right" style="background:#f1f5f9; color:#94a3b8;">${i + 1}</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>`;
            }
            tbody.innerHTML = html;
        }

        function loadProduct(id) {
            const p = DB.products.find(item => item.id == id);
            if (!p) return;
            const form = document.querySelector('#product-reg .form-container');
            const f = form.querySelectorAll('input, select');

            f[0].value = p.id;
            f[1].value = p.buyPrice || 0;
            f[2].value = p.name || '';
            f[3].value = p.sellPrice || 0;
            f[4].value = p.cate1 || '대분류 1';
            f[5].value = p.subCate1 || '소분류 1';
            f[6].value = p.stock || 0;
            f[7].value = p.priceA || 0;
            f[8].value = p.memo || '';
        }

        async function deleteProduct() {
            const form = document.querySelector('#product-reg .form-container');
            const fields = form.querySelectorAll('input, select');
            const id = fields[0].value;
            const p = DB.products.find(item => item.id == id);

            if (!p) return;
            if (!confirm('정말 삭제하시겠습니까?')) return;

            try {
                await db.collection("products").doc(p.uid).delete();
                newProduct();
                alert('삭제되었습니다.');
            } catch (error) {
                alert('삭제 실패: ' + error.message);
            }
        }

        function newProduct() {
            const form = document.querySelector('#product-reg .form-container');
            const fields = form.querySelectorAll('input, select');
            const ids = DB.products.map(p => parseInt(p.id) || 0);
            const nextId = Math.max(...ids, 1000) + 1;

            fields.forEach(f => f.value = '');
            fields[0].value = nextId;
            fields[2].value = '';
            fields[4].value = '대분류 1';
            fields[5].value = '소분류 1';
        }

        async function saveProduct() {
            const form = document.querySelector('#product-reg .form-container');
            const f = form.querySelectorAll('input, select');
            const id = f[0].value;

            const existing = DB.products.find(p => p.id == id);

            const productData = {
                id: id,
                buyPrice: parseInt(f[1].value) || 0,
                name: f[2].value,
                sellPrice: parseInt(f[3].value) || 0,
                cate1: f[4].value,
                subCate1: f[5].value,
                stock: parseInt(f[6].value) || 0,
                priceA: parseInt(f[7].value) || 0,
                memo: f[8].value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (existing && existing.uid) {
                productData.uid = existing.uid;
            }

            await saveData('product', productData);
            alert('저장되었습니다.');
            newProduct(); // 즉시 다음 번호로 세팅
        }

        // --- Transaction Logic (Sales/Purchase) ---
        function switchTradeType(type) {
            const title = document.getElementById('reg-title');
            const targetLabel = document.getElementById('target-label');
            const totalLabel = document.getElementById('total-label');
            const select = document.getElementById('trade-type-select');
            if (select) select.value = type;

            // 타이틀은 '매입&매출 등록'으로 고정하고 내부 레이블만 변경
            if (type === 'sales') {
                if (targetLabel) targetLabel.innerText = '매출거래처';
                if (totalLabel) totalLabel.innerText = '매출총액';
                if (select) select.style.color = '#004d99';
            } else {
                if (targetLabel) targetLabel.innerText = '매입거래처';
                if (totalLabel) totalLabel.innerText = '매입총액';
                if (select) select.style.color = '#e81123';
            }
        }

        async function saveTransaction() {
            const type = document.getElementById('trade-type-select').value;
            const customerInput = document.getElementById('sales-customer-input');
            const customer = customerInput ? customerInput.value.trim() : '';
            const memoText = document.querySelector('#sales-reg textarea')?.value || '';
            const date = document.querySelector('#sales-reg input[type="date"]')?.value || new Date().toISOString().split('T')[0];
            const seq = document.getElementById('reg-seq')?.value || '1';

            if (!customer) {
                alert('거래처를 선택해주세요.');
                return;
            }

            // 결제 정보
            const payCash = parseInt(document.getElementById('pay-cash')?.value) || 0;
            const payDiscount = parseInt(document.getElementById('pay-discount')?.value) || 0;
            const payBank = parseInt(document.getElementById('pay-bank')?.value) || 0;
            const payCard = parseInt(document.getElementById('pay-card')?.value) || 0;

            const rows = document.querySelectorAll('#sales-grid-body tr');
            const promises = [];

            // 기존 동일 전표 삭제 (수정 모드 대응)
            const existingRows = DB.transactions.filter(t => t.date === date && t.customer === customer && t.seq === seq);
            for (const rowObj of existingRows) {
                promises.push(db.collection('transactions').doc(rowObj.uid).delete());
            }

            rows.forEach((row) => {
                const pname = row.querySelector('.input-pname')?.value;
                const qty = parseInt(row.querySelector('.input-qty')?.value) || 0;
                const price = parseInt(row.querySelector('.input-price')?.value) || 0;
                const rowMemo = row.querySelector('.input-row-memo')?.value || '';

                if (pname && qty > 0) {
                    const transData = {
                        date, type, customer, pname, qty, price,
                        supply: qty * price,
                        tax: Math.floor(qty * price * 0.1),
                        memo: memoText,
                        rowMemo: rowMemo,
                        seq: seq,
                        payments: {
                            cash: payCash,
                            discount: payDiscount,
                            bank: payBank,
                            card: payCard
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    promises.push(saveData('transaction', transData));

                    // 재고 업데이트 로직 추가
                    const product = DB.products.find(p => p.name === pname);
                    if (product && product.uid) {
                        const newStock = type === 'sales' ? (product.stock || 0) - qty : (product.stock || 0) + qty;
                        promises.push(db.collection('products').doc(product.uid).update({
                            stock: newStock,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }));
                    }
                }
            });

            if (promises.length === 0 && existingRows.length === 0) {
                alert('저장할 항목이 없습니다.');
                return;
            }

            try {
                await Promise.all(promises);
                alert('전표가 저장/수정되었습니다.');
                renderSalesGrid();
                if (customer) updateCustomerHistory(customer);
            } catch (err) {
                console.error(err);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        function changeSeq(delta) {
            const seqInput = document.getElementById('reg-seq');
            let val = parseInt(seqInput.value) || 1;

            const todayStr = document.querySelector('#sales-reg input[type="date"]')?.value || new Date().toISOString().split('T')[0];

            // 오늘 날짜 전체 전표 중 최대 순번 찾기 (거래처 상관없이)
            const todayMatches = DB.transactions.filter(t => t.date === todayStr && t.seq);
            const maxSeq = todayMatches.reduce((max, t) => Math.max(max, parseInt(t.seq) || 0), 0);

            val += delta;
            if (val < 1) val = 1;
            // 오늘 입력한 마지막 번호 다음까지만 대기
            if (val > maxSeq + 1) val = maxSeq + 1;

            seqInput.value = val;
            loadTransactionBySeq();
        }

        function clearSalesGridOnly() {
            const rows = document.querySelectorAll('#sales-grid-body tr');
            rows.forEach(r => {
                r.querySelector('.input-pname').value = '';
                r.querySelector('.input-qty').value = '';
                r.querySelector('.input-price').value = '';
                r.querySelector('.cell-supply').innerText = '';
                r.querySelector('.input-row-memo').value = '';
            });
            updateTotals();
        }

        function loadTransactionBySeq() {
            const date = document.querySelector('#sales-reg input[type="date"]')?.value;
            const seq = document.getElementById('reg-seq').value;

            if (!date) return;

            // 거래처 상관없이 해당 날짜 + 순번으로 검색
            const matches = DB.transactions.filter(t => t.date === date && t.seq === seq);

            const customerInput = document.getElementById('sales-customer-input');
            const memoArea = document.querySelector('#sales-reg textarea');
            const rows = document.querySelectorAll('#sales-grid-body tr');

            // 그리드 및 결제칸 초기화
            rows.forEach(r => {
                r.querySelector('.input-pname').value = '';
                r.querySelector('.input-qty').value = '';
                r.querySelector('.input-price').value = '';
                r.querySelector('.cell-supply').innerText = '';
                r.querySelector('.input-row-memo').value = '';
            });
            document.getElementById('pay-cash').value = '0';
            document.getElementById('pay-discount').value = '0';
            document.getElementById('pay-bank').value = '0';
            document.getElementById('pay-card').value = '0';
            if (memoArea) memoArea.value = '';

            if (matches.length > 0) {
                // 전표 데이터 있으면 거래처부터 제품목록까지 싹 로드
                if (customerInput) {
                    customerInput.value = matches[0].customer || '';
                    updateCustomerHistory(customerInput.value); // 거래처 바뀌었으니 히스토리도 갱신
                }

                matches.forEach((data, i) => {
                    if (rows[i]) {
                        rows[i].querySelector('.input-pname').value = data.pname;
                        rows[i].querySelector('.input-qty').value = data.qty;
                        rows[i].querySelector('.input-price').value = data.price;
                        rows[i].querySelector('.cell-supply').innerText = (data.supply || 0).toLocaleString();
                        rows[i].querySelector('.input-row-memo').value = data.rowMemo || '';
                    }
                });

                const p = matches[0].payments || {};
                document.getElementById('pay-cash').value = p.cash || 0;
                document.getElementById('pay-discount').value = p.discount || 0;
                document.getElementById('pay-bank').value = p.bank || 0;
                document.getElementById('pay-card').value = p.card || 0;
                if (memoArea) memoArea.value = matches[0].memo || '';

                updateTotals();
            } else {
                // 데이터 없는 번호면 거래처 칸도 비워줌 (새 전표 모드)
                if (customerInput) customerInput.value = '';
                updateTotals();
            }
        }

        // --- Inquiry Logic ---
        function renderInquiryTable() {
            const tbody = document.getElementById('complex-inquiry-body');
            if (DB.transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" align="center" style="padding:20px;">조회된 내역이 없습니다.</td></tr>';
                return;
            }

            let html = DB.transactions.map((t, i) => {
                const supply = t.supply || 0;
                const tax = t.tax || 0;
                const total = supply + tax;
                const pay = (t.payments?.cash || 0) + (t.payments?.bank || 0) + (t.payments?.card || 0);

                return `
                <tr>
                    <td align="center" style="background:#1a1a1a; color:white; font-size:11px; border: 1px solid #333;">${i + 1}</td>
                    <td align="center">${t.date}</td>
                    <td style="font-weight:bold;">${t.customer}</td>
                    <td align="right">0</td>
                    <td align="right">${t.qty}</td>
                    <td align="right">${(t.price || 0).toLocaleString()}</td>
                    <td align="right">${supply.toLocaleString()}</td>
                    <td align="right">${(t.payments?.discount || 0).toLocaleString()}</td>
                    <td align="right" style="font-weight:bold;">${total.toLocaleString()}</td>
                    <td align="right" style="color:#2563eb;">${pay.toLocaleString()}</td>
                    <td align="right" style="font-weight:bold; color:#b91c1c;">${(total - pay).toLocaleString()}</td>
                </tr>
            `}).join('');

            // 빈 행 추가
            for (let i = DB.transactions.length; i < 25; i++) {
                html += `<tr>
                    <td align="center" style="background:#1a1a1a; color:#ccc; font-size:11px; border: 1px solid #333;">${i + 1}</td>
                    <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                </tr>`;
            }

            tbody.innerHTML = html;
        }

        // --- Sales Logic ---
        function updateDatalists() {
            // 제품 목록 datalist
            let prodDl = document.getElementById('product-list-dl');
            if (!prodDl) {
                prodDl = document.createElement('datalist');
                prodDl.id = 'product-list-dl';
                document.body.appendChild(prodDl);
            }
            prodDl.innerHTML = DB.products.map(p => `<option value="${p.name}">`).join('');

            // 거래처 목록 datalist
            let custDl = document.getElementById('customer-list-dl');
            if (!custDl) {
                custDl = document.createElement('datalist');
                custDl.id = 'customer-list-dl';
                document.body.appendChild(custDl);
            }
            custDl.innerHTML = DB.customers.map(c => `<option value="${c.name}">`).join('');
        }

        function renderSalesGrid() {
            const tbody = document.getElementById('sales-grid-body');
            if (!tbody) return;

            updateDatalists();

            let html = '';
            const minRows = 25;
            for (let i = 0; i < minRows; i++) {
                html += `
                    <tr>
                        <td align="right" style="background:#f1f5f9; color:#94a3b8; font-size:10px;">${i + 1}</td>
                        <td><input type="text" class="input-pname" list="product-list-dl" autocomplete="off" lang="ko" spellcheck="false" style="ime-mode:active;"></td>
                        <td><input type="text" class="input-qty" style="text-align:center; ime-mode:active;" autocomplete="off" onfocus="this.select()" oninput="this.value=this.value.replace(/[^0-9.-]/g,'')"></td>
                        <td><input type="text" class="input-price" style="text-align:right; ime-mode:active;" autocomplete="off" onfocus="this.select()" oninput="this.value=this.value.replace(/[^0-9.-]/g,'')"></td>
                        <td align="right" class="cell-supply" style="font-weight:bold; color:#1e293b;"></td>
                        <td><input type="text" class="input-row-memo" lang="ko" spellcheck="false" style="ime-mode:active;" autocomplete="off" onfocus="this.select()"></td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;

            // 상단 초기화
            const fieldsToClear = [
                'sales-customer-input', 'pay-cash', 'pay-discount', 'pay-bank', 'pay-card',
                'info-prev-balance', 'info-last-date', 'info-paying', 'info-today-sum', 'info-total-balance'
            ];
            fieldsToClear.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = (id.startsWith('info-') || id.startsWith('pay-')) ? '0' : '';
            });

            const memoArea = document.querySelector('#sales-reg textarea');
            if (memoArea) memoArea.value = '';

            // 작성순번 자동 채번 (화면의 거래일자 기준으로 마지막 순번 + 1)
            const dateInput = document.querySelector('#sales-reg input[type="date"]');
            const todayStr = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
            const maxSeq = DB.transactions
                .filter(t => t.date === todayStr && t.seq)
                .reduce((max, t) => Math.max(max, parseInt(t.seq) || 0), 0);

            const seqInput = document.getElementById('reg-seq');
            if (seqInput) seqInput.value = maxSeq + 1;

            // 작성시간 업데이트
            const timeInput = document.getElementById('reg-time');
            if (timeInput) {
                const now = new Date();
                timeInput.value = now.toTimeString().split(' ')[0];
            }

            updateTotals();
        }

        function updateCustomerHistory(customerName) {
            const historyBody = document.getElementById('side-history-body');
            if (!historyBody) return;

            // 히스토리 필터링
            const matches = DB.transactions.filter(t => t.customer === customerName).slice(-10);

            // 잔액 정보 자동 로드 (전일잔액 계산)
            // 실제 상용 앱에서는 과거 모든 트랜잭션의 합 - 모든 결제 합으로 구함
            const allCustTrans = DB.transactions.filter(t => t.customer === customerName);
            const totalSales = allCustTrans.filter(t => t.type === 'sales').reduce((sum, t) => sum + (t.supply || 0) + (t.tax || 0), 0);
            const totalPayments = allCustTrans.reduce((sum, t) => {
                const p = t.payments || {};
                return sum + (p.cash || 0) + (p.bank || 0) + (p.card || 0);
            }, 0);

            const currentBalance = totalSales - totalPayments;
            const prevBalanceEl = document.getElementById('info-prev-balance');
            if (prevBalanceEl) prevBalanceEl.value = currentBalance.toLocaleString();

            if (matches.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="3" align="center" style="padding:10px; color:#999;">기존 내역 없음</td></tr>';
                return;
            }
            historyBody.innerHTML = matches.reverse().map(t => `
                <tr>
                    <td align="center">${t.date.split('-').slice(1).join('/')}</td>
                    <td style="font-size:10px;">${t.pname}</td>
                    <td align="right">${t.qty}</td>
                </tr>
            `).join('');

            updateTotals(); // 잔액 반영 후 다시 계산
        }

        // --- Event Listeners ---
        document.body.addEventListener('input', function (e) {
            const target = e.target;
            const row = target.closest('tr');

            // 1. 거래처 입력 시 즉시 히스토리 로드
            if (target.id === 'sales-customer-input') {
                updateCustomerHistory(target.value);
            }

            if (!row) return;

            // 2. 제품명 입력 시/선택 시 단가 자동 연동
            if (target.classList.contains('input-pname')) {
                const pname = target.value.trim();
                const prod = DB.products.find(p => p.name === pname);
                if (prod) {
                    const type = document.getElementById('trade-type-select').value;
                    row.querySelector('.input-price').value = (type === 'sales' ? prod.sellPrice : prod.buyPrice) || 0;
                    if (!row.querySelector('.input-qty').value) row.querySelector('.input-qty').value = 1;
                }
            }

            // 3. 수량/단가 변경 시 합계 갱신
            if (target.classList.contains('input-qty') || target.classList.contains('input-price') || target.classList.contains('input-pname')) {
                const qty = parseFloat(row.querySelector('.input-qty')?.value) || 0;
                const price = parseFloat(row.querySelector('.input-price')?.value) || 0;
                const supply = qty * price;
                const supplyCell = row.querySelector('.cell-supply');
                if (supplyCell) supplyCell.innerText = supply > 0 ? supply.toLocaleString() : '';
                updateTotals();
            }
        });

        // 4. 엔터 키 이동 및 지능형 매칭 로직 (대폭 보강)
        document.body.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                const target = e.target;
                const row = target.closest('tr');

                // A. 제품명 필드에서 엔터 시 지능형 매칭
                if (row && target.classList.contains('input-pname')) {
                    const val = target.value.trim();
                    if (val) {
                        // 정확히 일치하거나, 해당 글자로 시작하는 첫 번째 제품 찾기
                        const match = DB.products.find(p => p.name === val) ||
                            DB.products.find(p => p.name.startsWith(val)) ||
                            DB.products.find(p => p.name.includes(val));

                        if (match) {
                            target.value = match.name; // 전체 이름으로 자동 완성
                            const type = document.getElementById('trade-type-select').value;
                            row.querySelector('.input-price').value = (type === 'sales' ? match.sellPrice : match.buyPrice) || 0;
                            if (!row.querySelector('.input-qty').value) row.querySelector('.input-qty').value = 1;
                            updateTotals();
                        }
                    }
                }

                // B. 거래처 필드에서 엔터 시 지능형 매칭
                if (target.id === 'sales-customer-input') {
                    const val = target.value.trim();
                    if (val) {
                        const match = DB.customers.find(c => c.name === val) ||
                            DB.customers.find(c => c.name.startsWith(val)) ||
                            DB.customers.find(c => c.name.includes(val));
                        if (match) {
                            target.value = match.name;
                            updateCustomerHistory(match.name);
                        }
                    }
                }

                // C. 포커스 자동 이동 (제품 그리드 내 네비게이션)
                if (row && row.parentElement.id === 'sales-grid-body') {
                    if (target.classList.contains('input-pname')) {
                        const val = target.value.trim();
                        if (DB.products.find(p => p.name === val)) {
                            e.preventDefault();
                            row.querySelector('.input-qty').focus();
                        } else {
                            e.preventDefault();
                            target.value = '';
                            updateTotals();
                        }
                    } else if (target.classList.contains('input-qty')) {
                        e.preventDefault();
                        row.querySelector('.input-price').focus();
                    } else if (target.classList.contains('input-price')) {
                        e.preventDefault();
                        row.querySelector('.input-row-memo').focus();
                    } else if (target.classList.contains('input-row-memo')) {
                        e.preventDefault();
                        const nextRow = row.nextElementSibling;
                        if (nextRow) {
                            nextRow.querySelector('.input-pname').focus();
                        }
                    }
                } else if (target.id === 'sales-customer-input') {
                    const val = target.value.trim();
                    if (DB.customers.find(c => c.name === val)) {
                        e.preventDefault();
                        const firstPname = document.querySelector('#sales-grid-body .input-pname');
                        if (firstPname) firstPname.focus();
                    } else {
                        e.preventDefault();
                        target.value = '';
                    }
                }
            }
        });

        // 5. 유효성 검사 및 데이터 정합성 유지

        document.body.addEventListener('change', function (e) {
            const target = e.target;
            if (target.classList.contains('input-pname')) {
                const val = target.value.trim();
                const match = DB.products.find(p => p.name === val);
                if (!match) {
                    target.value = ''; // 등록 안된 제품은 무조건 지움 (직접 입력 차단)
                    updateTotals();
                }
            }
            if (target.id === 'sales-customer-input') {
                const val = target.value.trim();
                if (val && !DB.customers.find(c => c.name === val)) {
                    target.value = ''; // 등록 안된 거래처 지움
                }
            }
        });

        function updateTotals() {
            let totalSupply = 0;
            document.querySelectorAll('.cell-supply').forEach(td => {
                totalSupply += parseFloat(td.innerText.replace(/,/g, '')) || 0;
            });
            const tax = Math.floor(totalSupply * 0.1);
            const todaySum = totalSupply + tax;

            if (document.getElementById('sum-supply')) document.getElementById('sum-supply').innerText = totalSupply.toLocaleString();
            if (document.getElementById('sum-tax')) document.getElementById('sum-tax').innerText = tax.toLocaleString();
            if (document.getElementById('sum-total-footer')) document.getElementById('sum-total-footer').innerText = todaySum.toLocaleString();

            // 상단 정보 바 업데이트
            const prevBalance = parseInt(document.getElementById('info-prev-balance')?.value.replace(/,/g, '')) || 0;
            const payCash = parseInt(document.getElementById('pay-cash')?.value) || 0;
            const payBank = parseInt(document.getElementById('pay-bank')?.value) || 0;
            const payCard = parseInt(document.getElementById('pay-card')?.value) || 0;
            const payDiscount = parseInt(document.getElementById('pay-discount')?.value) || 0;

            const totalPaying = payCash + payBank + payCard;

            if (document.getElementById('info-paying')) document.getElementById('info-paying').value = totalPaying.toLocaleString();
            if (document.getElementById('info-today-sum')) document.getElementById('info-today-sum').value = todaySum.toLocaleString();
            if (document.getElementById('info-discount-sum')) document.getElementById('info-discount-sum').value = payDiscount.toLocaleString();

            // 총 잔액 = 전일잔액 + 금일합계 - 입금금액 - 할인금액(필요시)
            const totalBalance = prevBalance + todaySum - totalPaying - payDiscount;
            if (document.getElementById('info-total-balance')) document.getElementById('info-total-balance').value = totalBalance.toLocaleString();
        }

        renderSalesGrid();
        showWindow('sales-reg');
        switchTradeType('sales');
    </script>
</body>

</html>